---
editor_options:
  chunk_output_type: console
---
```{r ddm-descriptive-setup}
# Library calls
library(brms)
library(tidyverse)
library(tidybayes)
library(emmeans)
library(loo)
library(gridExtra)
library(ggpubr)
```

```{r ddm-descriptive-functions}
n_divergent <- function(model){
  sum(subset(nuts_params(model), Parameter=="divergent__")$Value)
}

prep_drift <- function(data){
  data %>% 
    filter(param == "drift")
}

prep_bs <- function(data){
  data %>% 
    filter(param == "bs")
}

prep_ndt <- function(data){
  data %>% filter(param == "ndt")
}

prep_bias <- function(data){
  data %>% 
    filter(param == "bias")
}

plot_robust <- function(data){
  data %>% 
    ggplot(
      aes(
        x = error_factor,
        y = mean
      )
    )+
  geom_point()+
    # geom_bar(stat = "identity", position = "dodge", width = 0.6)+
    geom_errorbar(
      aes(
        ymin = upper, 
        ymax = lower, 
        width = 0.2
      ),
    )+
    labs(
      y = "",
      x = ""
    )+
    theme_classic()+
    theme(text =element_text(size=20))
}
```

```{r ddm-descriptive-data, cache = TRUE}
# Reading in data 
fit_robust <- rio::import("./markdown/diffusion_model_runs/cluster/output/hierarch_model_long_robust.rda")

fit_speed <- rio::import("./markdown/diffusion_model_runs/cluster/output/hierarch_model_speeding.rda")

fit_classic <- rio::import("./markdown/diffusion_model_runs/cluster/output/hierarch_model_long_classic.rda")
```

```{r ddm-descriptive-counting-location, cache = TRUE, dependson='ddm-descriptive-data'}
model_robust_count <- fit_robust$data %>% 
  count(id, error_factor) %>%
  group_by(error_factor) %>% 
  summarize(
    median = median(n),
    sd = sd(n),
    total = sum(n)
  )

model_classic_count <- fit_classic$data %>% 
  count(id, error_factor) %>% 
  group_by(error_factor) %>% 
  summarize(
    median = median(n),
    sd = sd(n),
    total = sum(n)
  )

model_speed_count <- fit_speed$data %>% 
  count(id, error_factor) %>% 
  group_by(error_factor) %>% 
  summarize(
    median = median(n),
    sd = sd(n),
    total = sum(n)
  )

```

```{r ddm-descriptive-robust, cache = TRUE}
data_robust <- fixef(fit_robust) %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  select(param = rowname,
         mean = Estimate,
         error = `Est.Error`,
         lower = Q2.5,
         upper = Q97.5)


working_robust <- data_robust %>% 
  mutate(param = str_replace(param, "^error_factor", "drift_error_factor")) %>% 
  mutate(
    param = str_remove(param, "error_factor"),
    param = str_remove(param, "_error$")
  ) %>% 
  separate(
    param,
    into = c("param", "error_factor"),
    sep = "_"
  ) %>% 
  mutate(error_factor = paste0(error_factor, "-error")) %>% 
  mutate(error_factor = factor(error_factor)) %>% 
  mutate(error_factor = fct_relevel(error_factor, "pre-error", "post-error"))
 
summary_robust <- working_robust

drift_robust_plot <- summary_robust %>%
  prep_drift() %>%
  plot_robust()

ndt_robust_plot <- summary_robust %>% 
  prep_ndt() %>% 
  plot_robust()

bs_robust_plot <- summary_robust %>% 
  prep_bs() %>% 
  plot_robust()

bias_robust_plot <- summary_robust %>% 
  prep_bias() %>% 
  plot_robust()

combined_robust_plot <- ggarrange(drift_robust_plot, bs_robust_plot, ndt_robust_plot, bias_robust_plot, labels = c("v", "a", "Ter", "D"))
```

```{r ddm-descriptive-classic, cache = TRUE, eval = FALSE}
data_classic <- fixef(fit_classic) %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  select(param = rowname,
         mean = Estimate,
         error = `Est.Error`,
         lower = Q2.5,
         upper = Q97.5)


working_classic <- data_classic %>% 
  mutate(param = str_replace(param, "^error_factor", "drift_error_factor")) %>% 
  mutate(
    param = str_remove(param, "error_factor")
  ) %>% 
  mutate(
    param = str_remove(param, "post_")
  ) %>% 
  separate(
    param,
    into = c("param", "error_factor"),
    sep = "_"
  ) %>% 
  mutate(error_factor = paste0("post-", error_factor)) %>% 
  mutate(error_factor = factor(error_factor)) %>% 
  mutate(error_factor = fct_relevel(error_factor, "post-correct", "post-error"))

summary_classic <- working_classic

drift_classic_plot <- summary_classic %>%
  prep_drift() %>% 
  plot_robust()

bs_classic_plot <- summary_classic %>%
  prep_bs() %>%
  plot_robust()

ndt_classic_plot <- summary_classic %>%
  prep_ndt() %>%
  plot_robust()

bias_classic_plot <- summary_classic %>%
  prep_bias() %>%
  plot_robust()

combined_classic_plot <- ggarrange(drift_classic_plot, bs_classic_plot, ndt_classic_plot, bias_classic_plot, labels = c("v", "a", "Ter", "D"))

```

```{r ddm-descriptive-speeding, cache = TRUE}
data_speed <- fixef(fit_speed) %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  select(param = rowname,
         mean = Estimate,
         error = `Est.Error`,
         lower = Q2.5,
         upper = Q97.5)


working_speed <- data_speed %>% 
  mutate(param = str_replace(param, "^error_factor", "drift_error_factor")) %>% 
  mutate(
    param = str_remove(param, "error_factor")
  ) %>% 
  separate(
    param,
    into = c("param", "error_factor"),
    sep = "_"
  ) %>% 
  mutate(error_factor = ifelse(error_factor == "EM1", "error", "correct")) %>% 
  mutate(error_factor = paste0("pre-", error_factor)) %>% 
  mutate(error_factor = factor(error_factor)) %>% 
  mutate(error_factor = fct_relevel(error_factor, "pre-correct", "pre-error"))

summary_speed <- working_speed

drift_speed_plot <- summary_speed %>%
  prep_drift() %>% 
  plot_robust()
bs_speed_plot <- summary_speed %>%
  prep_bs() %>%
    plot_robust()

ndt_speed_plot <- summary_speed %>%
  prep_ndt() %>%
  plot_robust()

bias_speed_plot <- summary_speed %>%
  prep_bias() %>%
  plot_robust()

combined_speed_plot <- ggarrange(drift_speed_plot, bs_speed_plot, ndt_speed_plot, bias_speed_plot, labels = c("v", "a", "Ter", "D"))
```

