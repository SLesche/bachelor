# Method
```{r method-source-data-prep, child = "./markdown/data_prep.rmd"}
```

## Participants
```{r method-source-power-analysis, child = "./markdown/power_analysis.rmd", eval = TRUE}
```
We recruited a total of `r demo_output$n_subjects` (`r demo_output$n_women` females, M = `r round(demo_output$mean_age, 2)`, SD = `r round(demo_output$sd_age, 2)`) participants. Participants were tested in a single session, gave informed consent and received course credit for their participation. With 93 participants a 2x2 repeated measures ANOVA with a power of $0.80$ is sensitive to effect sizes of $\eta^2 =$ `r cohen_f_sensitivity_80`.

## Materials
The experiment was programmed using the PsychoPy software [@peirce2019]. We used a modified version of the Behavior Adaptation Task (BAT) [@hester2007] -- a motor-inhibition Go-NoGo task. Stimuli consisted of a stream of the letters X and Y presented in black centrally on a grey background (see Figure \@ref(fig:method-bat-example)). Participants were asked to respond to the letters when they occurred in an alternating pattern (Go trial) but withhold their response on repeated presentation of a stimulus (NoGo trial). Letters measured approximately 2.5 degrees vertically, the fixation cross measured 1 degree horizontally and vertically and was printed black. Participants were seated approximately 60cm away from the monitor.

(ref:method-bat-example-caption) Behavioral Adaptation Task

```{r method-bat-example, fig.cap = paste("(ref:method-bat-example-caption)")}
knitr::include_graphics(
  "images/bat_slide_pp/Slide1.png"
)
```

## Procedure
Participants were asked to respond as quickly and accurately as possible. Instructions on response mappings of stimuli X and Y to the response keys D and L were counterbalanced across participants. Stimuli were presented for 800ms or until a response was given. We set the RSI to 200ms for the short condition and 1000ms for the long condition. A fixation cross was presented during the RSI. Participants completed 30 practice trials, 15 of which with short RSI and 15 with long RSI. Participants received feedback informing them about their performance only in practice trials. The word "richtig" (german for _correct_) was printed in green following a correct response, "falsch" (german for _incorrect_) was printed in red following a false response. When participants erroneously responded in a NoGo-trial, they were reminded not to respond when stimuli were repeated. RSI was manipulated between experimental blocks, with six blocks consisting of 250 trials each being presented per RSI condition. NoGo trials made up approximately 25% of trials. Blocks of short and long RSI occurred in an alternating pattern, beginning with the long RSI condition. A self-paced break was administered following each experimental block. The sequence of appearance of stimuli X and Y was generated pseudo-randomly. Fourfold repetitions of a stimulus were prohibited, and NoGo-trials were always preceded by another NoGo trial or at least two Go trials. This was done to ensure that post-error trials were never simultaneously pre-error trials. 

## Data preparation
All response times shorter than 150ms were excluded from analysis. Mean RT and accuracy for each participant in each combination of RSI (short -- long) and trial type (Go -- NoGo) were considered outliers if the participant's mean deviated more than 3 standard deviations from the mean across participants for that combination of RSI and trial type. A total of `r n_outliers` participants were excluded due to this criterion, leaving `r demo_output$n_subjects - n_outliers` participants for analysis. Since response times had an upper limit of 800ms, we chose not to exclude trials on a within-participant basis.

## Behavioral analysis
Because very few errors of commission occurred in Go trials, only errors in NoGo trials were considered _error trials_ relevant for analysis. Inspection of only the effect of accuracy in NoGo trials allows classification of Go trials based on the accuracy of the most proximate NoGo trial. Go trials following a NoGo-error are defined as trials _E+1_, trials preceding NoGo trials were defined as _E-1_ or _C-1_ depending on the accuracy of that NoGo trial. In line with the classical measure of PES, we defined trial following correct Go trials as _C+1_. Trials following correct NoGo trials are excluded from being defined as _post-error_ because they follow an inhibited response.

To quantify the impact of an error on a variable $\theta$, we used models testing both the classical approach to PES
$$\Delta_{PES} = \overline{\theta_{E+1}} - \overline{\theta_{C+1}}$$ 
as well as the robust approach to PES [@dutilh2012how].
$$ \Delta_{PES} = \overline{\theta_{E+1}} - \overline{\theta_{E-1}}$$

When investigating the specific impact of an error-response on the following trial we will conduct our analyses using the robust definition of PES to account for global shifts in performance^[We conducted all behavioral and DDM analysis with the classical measure of PES as well [@dutilh2012how]. Results did not differ significantly, see Appendix //REPLACE// for  details on global performance shifts and model results]. Parameters and behavioral measures in trials following an error will be compared to trials preceding an error to ensure that post-error trials and trials used to estimate a baseline originate from the same place in the dataset. This prevents biased sampling of post-error trials depending on global performance shifts. 

_Pre-error speeding_ effects can be estimated as follows.
$$\Delta_{speed} = \overline{\theta_{C-1}} - \overline{\theta_{E-1}}$$

## Bayesian hierarchical drift-diffusion model
The diffusion model was estimated using a Bayesian hierarchical approach implemented in the R-package `brms` [@R-brms_a]. Hierarchical approaches to the DDM allow simultaneous estimation of parameters on both a population-level and on a subject-level [@vandekerckhove2011; @lee2011; @gelman2006], reducing the number of samples required to estimate model parameters reliably [@wiecki2013; @ratcliff2015; @rouder2005]. Bayesian estimation allows hierarchical extensions of the model otherwise not feasible in frequentist approaches using maximum likelihood estimation [@vandekerckhove2011] and produces more accurate model estimates [@rouder2005]. Individual-level parameters are assumed to be random samples drawn from a group-level distribution. Group-level distributions thus define between-subjects variability of the parameters and are themselves specified by a set of parameters [@matzke2009]. The ability to fully infer posterior distributions and thus allow a more intuitive quantification of uncertainty is a further benefit of bayesian estimation [@kruschke2010].

## Model comparison
To examine the best-fitting model able to explain post-error effects we tested models using the robust definition of PES. These models include pre-error (E-1) and post-error (E+1) trials in both RSI conditions. We then selectively disabled the impact of RSI or _error-condition_ on parameters and estimated their pointwise out-of-sample prediction accuracy using the PSIS-LOO criterion [@vehtari2017] approximation  implemented in the `loo` package [@R-loo_b].

A model with the factors RSI and error-condition both affecting all parameters was used as a baseline. We tested 14 other models that selectively disabled the impact of one of the factors on either all, one or all but one parameters of the model. This results in 1 baseline model, 1 model with RSI not impacting any parameters, 1 model with error-condition not affecting any parameter, 4 models with only one of the 4 DDM parameters varying between error-conditions, 4 models with one of the parameters not being allowed to vary between error-conditions and 4 models with one of the parameters not being allowed to vary between RSI conditions. The parameter specification of the best fitting model was then employed on the full location dataset and is reported below.

## Model specification
Let $\mathbf{Y_{(ijk)}}$ represent a response vector of the decision and response time $(X_{(ijk)}, T_{(ijk)})$ for the $i$th participant, in the $j$th trial of the $k$th condition. The data is assumed to follow a Wiener distribution,
$$\mathbf{Y_{(ijk)}} \sim Wiener(\alpha_{(ijk)}, \beta_{(ijk)}, \tau_{(ijk)}, \delta_{(ijk)})$$
with the four model parameters boundary separation $\alpha$, bias $\beta$, non-decision time $\tau$ and drift-rate $\delta$. Responses $X_{(ijk)}$ can take the values $X_{(ijk)} = \{0,1\}$. $X_{(ijk)} = 0$ represents the decision that the stimulus shows the letter _X_, corresponding to the lower response boundary. $X_{(ijk)} = 1$ represents the respective decision that the stimulus shows the letter _Y_. Response time (in $s$) can take on any value $T_{(ijk)} \in (0, 0.8]$. A response $\mathbf{Y_{(ijk)}}$ of participant $i$ on trial $j$ is further influenced by the combination $k$ of the conditions RSI (short -- long) and location (C-1, E-1, E+1 ...), depending on the measure tested.

All parameters were allowed to vary between conditions (see Figure \@ref(fig:method-display-model-spec)). All intercepts were fixed to zero in order to estimate group-level parameters for each combination of factors instead of deviations from a baseline, easing specification of priors [@singmann2017intro]. Drift rate was further allowed to vary depending on the true status of the presented stimulus $s$, accounting for differences in drift direction depending on the presented stimulus. Because the task relied heavily on the alternation of stimuli "X" and "Y", the bias parameter was allowed to vary depending on the status of the previously presented stimulus $p$.
The model estimates parameters defining the group-level distribution from which individual-level parameters are then drawn. Boundary separation $\alpha_{ik}$ of individual $i$ in condition $k$, for example, is assumed to follow the distribution $\alpha_{ik} \sim N(\mu_{\alpha k}, \sigma_{\alpha k})$.

(ref:method-display-model-spec-caption) Graphical representation of model specification. Shaded nodes represent measured parameters. 

```{r method-display-model-spec, fig.cap = paste("(ref:method-display-model-spec-caption)")}
knitr::include_graphics(
  "images/model_spec_slide_image.jpg"
)
```


Priors for the group-level parameters were specified in a weakly informative manner. Priors were specified simultaneously for all conditions $k$ of a diffusion model parameter. The index $k$ is thus omitted.

$$\delta \sim Normal(0, 5)$$
$$\sigma_{\delta} \sim Gamma(2, 4)$$
$$\alpha \sim Gamma(10, 5)$$
$$\sigma_{\alpha} \sim Gamma(2, 4)$$
$$\tau \sim Gamma(1, 5)$$
$$\sigma_{\tau} \sim Gamma(2, 4)$$
$$\tau \sim Beta(4, 4)$$
$$\sigma_{\beta} \sim Gamma(2, 4)$$
```{r method-setup-model}
n_iter <- 3000
n_warmup <- 1000
n_chains <- 4
n_cores <- 64
max_depth <- 15
adapt_delta <- 0.95
seed <- 1234

model_setup_values <- data.frame(n_iter, n_warmup, n_chains, n_cores, max_depth,
                                 adapt_delta, seed)
```

## Model analysis
The diffusion model runs `r model_setup_values$n_chains` chains for `r model_setup_values$n_iter` iterations each, with `r model_setup_values$n_warmup` iterations per chain being used as a warmup to adapt the sampler. Final analysis was based on `r (model_setup_values$n_iter - model_setup_values$n_warmup)*model_setup_values$n_chains` iterations. Treedepth was set to `r model_setup_values$max_depth` and `adapt_delta` was set to `r model_setup_values$adapt_delta`. Following checks for model convergence, we will draw posterior samples and asses the fit of the model to our experimental data. We will compare parameter posterior distributions between levels of the conditions $k$ to investigate the effects of errors and RSI on diffusion model parameters. A full model using the _location_ approach will grant an overview over the development of parameters following error responses. Post-error effects will be quantified by comparing parameters in locations pre-error (E-1) to post-error (E+1).
