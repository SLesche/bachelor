<!-- This file is for LaTeX and R setups -->
<!-- Latex -->
<!-- Problem with Latex stuff is, that it won't compile to word correctly... -->

<!-- R -->

```{r libraries}
# think about calling renv here to make sure everyone has the same packages installed

library(papaja)
library(tidyverse)
library(Superpower)
library(rio)
library(flextable)
library(ftExtra)
library(rmarkdown)
library(knitr)
r_refs("r-references.bib")
r_citations <- cite_r(
  file = "r-references.bib",
  pkgs = c("papaja", "tidyverse"),
  omit = FALSE
  )

```

```{r custom-source}
rmd_source <- function(file){
  if (file.exists(file)){
    # Extract file name
    file_name_extenstion <- str_extract(
      file,
      "([^/]+)(?:\\.[*]+)?$"
    )
    
    file_name <- str_extract(
      file_name_extenstion,
      "([^\\.]+)"
    )
    
    # Convert to R-script
    knitr::purl(
      file,
      documentation = 0
    )
    
    # Then source that new file name
    source(paste0(file_name, ".r"))
  } 
  else {
    stop("This file doesn't exist")
  }
}
```

```{r custom-knit-child}
add_prefix_chunk_labels <- function(file){
  if (file.exists(file)){
    # Extract file name
    file_name_extenstion <- str_extract(
      file,
      "([^/]+)(?:\\.[*]+)?$"
    )
    
    file_name <- str_extract(
      file_name_extenstion,
      "([^\\.]+)"
    )
    # Read in the File
    lines <- readLines(file)
    
    # Change code labels
    replaced_lables <- str_replace(
      lines,
      "(```\\{r[ ]+)([^,}]+)",
      paste0(
        "\\1",
        str_replace_all(file_name, "_", "-"),
        "-",
        "\\2")
    )
    # write to new file
    return(replaced_lables)
  } 
  else {
    stop("This file doesn't exist")
  }
}

remove_yaml <- function(lines){
  if (length(c(which(lines == "---"))) == 2){
    yaml_start_stop <- which(
      lines == "---"
      )
    no_yaml_lines <- lines[-c(yaml_start_stop[1]:yaml_start_stop[2])]
    return(no_yaml_lines)
  } else {
    stop("Could no identify stop and start of YAML line")
  } 
}

custom_child <- function(file){
  chunk_prefix <- add_prefix_chunk_labels(file)
  no_yaml <- remove_yaml(chunk_prefix)
  temp_file = tempfile(fileext = ".rmd")
  cat(no_yaml, temp_file)
  knit_child(temp_file)
}
```

```{r tinytex}
# want to auto-install tinytex 
# if(tinytex::is_tinytex() == FALSE){
#   tinytex::install_tinytex()
# }
rprojroot::find_root(rprojroot::has_file("renv.lock"))
```

```{r analysis-preferences}
# set flextable defaults for fonts
set_flextable_defaults(fonts_ignore = TRUE)
```

```{r transpose-function}
df_transpose <- function(df) {
  
  first_name <- colnames(df)[1]
  
  temp <-
    df %>% 
    tidyr::pivot_longer(-1) %>%
    tidyr::pivot_wider(names_from = 1, values_from = value)
  
  colnames(temp)[1] <- first_name
  temp
}
```

```{r apa-footer-flextable}
apa_footer <- function(data, note){
  flextable::add_footer_lines(
    x = data,
    " "
    ) %>%
    flextable::compose(
      # x = data,
      i = 1,
      j = 1,
      part = "footer",
      value = as_paragraph(
        as_i("Note. "), note
      )
    )
}
```

```{r print-flextable}
print_flextable_apa <- function(x){
  flextable::flextable_to_rmd(
    x,
    ft.align = "left",
    ft.keepnext = TRUE,
    bookdown = TRUE,
    print = TRUE
  )
}
```

