---
editor_options:
  chunk_output_type: console
---
# Library calls
```{r setup}
library(tidyverse)
library(rio)
library(data.table)
library(scales)

ggplot2::theme_set(theme_classic()) # setting default theme
```

```{r functions}

```

```{r data}
data <- rio::import("./markdown/data/analysis_data.Rdata")
```

```{r descriptive data}
mean_error_rate_overall <- (1 - mean(data$acc, na.rm = TRUE)) * 100

mean_error_rate_nogo <- data %>% 
  filter(trial_type == "nogo") %>% 
  summarise(mean_acc = mean(acc, na.rm = TRUE))

mean_error_rate_nogo <- (1 - mean_error_rate_nogo$mean_acc)*100

mean_rt <- mean(data$rt, na.rm = TRUE)

mean_rt_short <- data %>% 
  filter(rsi == 0.2) %>% 
  summarise(mean_rt = mean(rt, na.rm = TRUE)) %>% .$mean_rt

mean_rt_long <- data %>% 
  filter(rsi == 1) %>% 
  summarise(mean_rt = mean(rt, na.rm = TRUE)) %>% .$mean_rt

# Want to do descriptives with classic pes. robust makes no sense with go-nogotask
mean_rt_post_correct <- data %>% 
  filter(classic_pes_type == "post_correct") %>% 
  summarise(mean_rt = mean(rt, na.rm = TRUE)) %>% .$mean_rt

mean_rt_post_error <- data %>% 
  filter(classic_pes_type == "post_error") %>% 
  summarise(mean_rt = mean(rt, na.rm = TRUE)) %>% .$mean_rt

mean_acc_post_correct <- data %>% 
  filter(classic_pes_type == "post_correct") %>% 
  summarise(mean_acc = mean(acc, na.rm = TRUE)) %>% .$mean_acc

mean_acc_post_error <- data %>% 
  filter(classic_pes_type == "post_error") %>% 
  summarise(mean_acc = mean(acc, na.rm = TRUE)) %>% .$mean_acc

mean_acc_error_rsi_comp <- data %>%
  group_by(rsi, classic_pes_type) %>% 
  summarise(mean_acc = mean(acc, na.rm = TRUE))

mean_rt_error_rsi_comp <- data %>% 
  group_by(rsi, classic_pes_type) %>% 
  summarise(mean_rt = mean(rt, na.rm = TRUE))

# TODO: Create dataframe containing descriptive mean rts and accs for different conditions
# Want mean rt on 

descriptive_output <- data.frame(
  mean_error_rate_overall,
  mean_error_rate_nogo,
  mean_rt,
  mean_rt_short,
  mean_rt_long,
  mean_rt_post_correct,
  mean_rt_post_error,
  mean_acc_post_correct,
  mean_acc_post_error
)
```

```{r classic pes}
# Maybe we'd wanna run this, to compare trials on equal footing
# nonetheless, a "correct" response means waiting longer, leading to different rt then after an error response
data %>% 
  group_by(rsi, classic_pes_type) %>% 
  summarize(mean_rt = mean(rt, na.rm = TRUE), 
            count = n())

data %>% 
  group_by(id, rsi) %>% 
  count(classic_pes_type) %>% 
  filter(classic_pes_type == "post_error",
         n < 50) %>%
  View()
```

```{r block comparison}
data %>% 
  group_by(rsi, block) %>% 
  # filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>% 
  summarize(mean_rt = mean(rt, na.rm = TRUE),
            mean_acc = mean(acc, na.rm = TRUE),
            count = n()) %>% 
  ggplot(aes(
    x = block,
    y = mean_rt,
    group = rsi,
    color = factor(rsi)
  ))+
  geom_line()

data %>% 
  mutate(block_fifths = case_when(
    trial < 50 ~ block + 0.2,
    trial < 100 ~ block + 0.4,
    trial < 150 ~ block + 0.6,
    trial < 200 ~ block + 0.8,
    trial < 250 ~ block + 1
  )) %>%
  group_by(rsi, block_fifths) %>%
  # filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>%
  summarize(mean_rt = mean(rt, na.rm = TRUE),
            mean_acc = mean(acc, na.rm = TRUE),
            count = n()) %>% 
  ggplot(aes(
    x = block_fifths,
    y = mean_acc,
    group = rsi,
    color = factor(rsi)
  ))+
  geom_line()
# Check whether accuracy difference overall in RSI is driven by go trials
data %>% 
  group_by(rsi, trial_type, block) %>% 
  summarise(mean_rt = mean(rt, na.rm = TRUE),
            mean_acc = sum(acc)/n(),
            count = n())
```

```{r visualization}
data %>% 
  group_by(rsi, error_code) %>% 
  # filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>% 
  summarise(
    mean_rt = mean(rt, na.rm = TRUE),
    sd_rt = sd(rt, na.rm = TRUE),
    mean_acc = mean(acc, na.rm = TRUE),
    sd_acc = sd(acc, na.rm = TRUE)
  ) %>% 
  mutate(error_code = ifelse(is.na(error_code), "other", error_code)) %>% 
  ggplot(aes(
    x = error_code, 
    y = mean_rt,
    group = rsi,
    color = factor(rsi)
  )) +
  geom_line()

data %>% 
  group_by(rsi, error_code) %>% 
  # filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>% 
  summarise(
    mean_rt = mean(rt, na.rm = TRUE),
    sd_rt = sd(rt, na.rm = TRUE),
    mean_acc = mean(acc, na.rm = TRUE),
    sd_acc = sd(acc, na.rm = TRUE)
  ) %>% 
  mutate(error_code = ifelse(is.na(error_code), "other", error_code)) %>% 
  filter(error_code %in% c(-1, 1, "other")) %>% 
  ggplot(aes(
    x = error_code,
    y = mean_acc,
    group = rsi,
    color = factor(rsi)
  )) +
  geom_line()

plot_rt_pes <- data %>% 
  group_by(rsi, classic_pes_type) %>% 
  # filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>% 
  summarise(
    across(
      c("rt", "acc"),
      list(sd = ~sd(., na.rm = TRUE), mean = ~mean(., na.rm = TRUE))
      )
    ) %>% 
  mutate(classic_pes_type = ifelse(is.na(classic_pes_type), "other", classic_pes_type)) %>% 
  filter(classic_pes_type != "other") %>% 
  ggplot(
    aes(
      x = factor(rsi),
      y = rt_mean,
      group = classic_pes_type,
      fill = classic_pes_type
    )
  ) +
  geom_bar(stat = "identity", position = "dodge")+
  labs(
    title = "Mean Reaction Times",
    x = "Response Stimulus Interval (s)",
    y = "Mean Reaction Time (s)",
    fill = ""
  )

plot_acc_pes <- data %>% 
  group_by(rsi, classic_pes_type) %>% 
  # filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>% 
  summarise(
    across(
      c("rt", "acc"),
      list(sd = ~sd(., na.rm = TRUE), mean = ~mean(., na.rm = TRUE))
      )
    ) %>% 
  mutate(classic_pes_type = ifelse(is.na(classic_pes_type), "other", classic_pes_type)) %>% 
  filter(classic_pes_type != "other") %>% 
  ggplot(
    aes(
      x = factor(rsi),
      y = acc_mean,
      group = classic_pes_type,
      fill = classic_pes_type
    )
  ) +
  geom_bar(stat = "identity", position = "dodge")+
  labs(
    title = "Mean Accuracy",
    x = "Response Stimulus Interval (s)",
    y = "Mean Accuracy",
    fill = ""
  )+
  scale_y_continuous(labels = label_percent())
```

# TODO: Something about "fast" vs. "slow" errors
```{r error rate without noresponse}
data %>% 
  group_by(rsi, error_code) %>% 
  filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>% 
  summarize(
    across(
      c("rt", "acc"),
      list(mean = ~mean(., na.rm = TRUE)) 
    )
  )
```


```{r fast slow error}
data %>% 
  filter(!is.na(error_speed)) %>% 
  filter(!is.na(rt) & trial_type == "go" | trial_type == "nogo") %>% 
  group_by(rsi, error_speed, error_code) %>% 
  summarize(
    across(c("rt", "acc"),
    list(
      mean = ~mean(., na.rm = TRUE), 
      sd = ~sd(., na.rm = TRUE)
      )
    )
  )
```


```{r condition comparison}
data %>% 
  group_by(rsi, map_condition) %>% 
  summarize(
    across(c("rt", "acc"),
    list(
      mean = ~mean(., na.rm = TRUE), 
      sd = ~sd(., na.rm = TRUE),
      count = ~n()
      )
    )
  )

```

```{r exporting}
rio::export(descriptive_output, "./markdown/data/descriptive_output.rdata")
ggsave(plot_rt_pes, file = "./markdown/images/plot_rt_pes.jpg")
ggsave(plot_acc_pes, file = "./markdown/images/plot_acc_pes.jpg")
```

