---
editor_options:
  chunk_output_type: console
---
# Library calls
```{r setup}
library(tidyverse)
library(rio)
library(data.table)
```

```{r functions}

```

# Reading in data
```{r importing data}
path <- "./markdown/data/"
keyword <- "bat_bachelor"

data <- list.files(
  path = path,
  pattern = keyword,
  full.names = T
  ) %>%
  map(import) %>% 
  data.table::rbindlist(
    fill = TRUE
  ) %>% 
  mutate(key_resp_trial.rt = ifelse(participant %in% 1:3, # added a 0.1 dead time after first three participants
                                    key_resp_trial.rt,
                                    key_resp_trial.rt + 0.1))
```

```{r checking condition mappings}
condition_table <- data %>% 
  count(map_condition, map_x_key, map_y_key) %>% 
  filter(!is.na(map_condition))
```

```{r extracting demo data}
demo_data <- "REPLACE ME CORRECTLY"
# No demo data was collected for first 7 participants (have in logbuch_ba.xlsx)
```

# Filtering out practice trials
```{r sort exp trials}
exp_data <- data %>% 
  filter(is.na(loop_practice.thisN)) %>%  # Filter all practice trials
  janitor::remove_empty(which = "cols") %>%  # remove all columns that have just NA, could also remove all empty rows aswell
  janitor::clean_names()# make names all snake case

exp_data <- exp_data %>% # adding acc and rt variables, selecting important values to front
  mutate(acc = key_resp_trial_corr,
         rt = key_resp_trial_rt) %>% 
  select(participant, loop_exp_this_n, loop_trials_this_n, trial_type, acc, rt,
         everything())
```

```{r just experimental data}
rt_data <- exp_data %>% 
  filter(!is.na(loop_exp_this_n)) # n.obs should be multiple of 3000
```

```{r coding error types}
# just coding errors in nogo trials as error
error_data <- rt_data %>% 
  group_by(participant, loop_exp_this_n) %>%  # consecutive errors have to be within a participant and block
  mutate(
    error_type = case_when(
      trial_type == "nogo" & acc == 0 & lag(trial_type) == "go" & lead(trial_type) =="go" ~ "error_single_lure",
      trial_type == "nogo" & acc == 0 & lag(trial_type) == "go" & lead(trial_type) == "nogo" ~ "error_double_lure_first",
      trial_type == "nogo" & acc == 0 & lag(trial_type) == "nogo" & lead(trial_type) == "go" ~ "error_double_lure_second",
    )
  ) %>% 
  mutate(
    error_code = case_when(
      lead(error_type) == "error_single_lure" ~ -1,
      error_type == "error_single_lure" ~ 0,
      lag(error_type) == "error_single_lure" ~ 1
    )
  ) %>% 
  ungroup()  %>% 
  group_by(participant, loop_exp_this_n) %>% 
  mutate(classic_pes_type = case_when(
    lag(trial_type, 2) == "go" & lag(trial_type) == "nogo" & trial_type == "go" & lag(acc) == 0 ~ "post_error",
    lag(trial_type, 2) == "go" & lag(trial_type) == "nogo" & trial_type == "go" & lag(acc) == 1 ~ "post_correct"
  )) %>% 
  ungroup()
```

```{r filtering participants}
# Filter out too fast responses aswell as 
final_data <- error_data
```


```{r saving data}
export(final_data, "./markdown/data/analysis_data.Rdata")
```

